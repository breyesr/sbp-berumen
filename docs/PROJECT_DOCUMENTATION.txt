Synthetic Persona Web — Technical Documentation
==============================================

1. Product Overview
-------------------
- Goal: help SMBs stress‑test ideas with synthetic personas and generate tailored marketing copy.
- Stack: Next.js 16 (app router) with React 19 client components, Tailwind CSS v4.
- Data inputs: local JSON/MD fixtures under `data/` plus OpenAI APIs for reasoning and embeddings.
- RAG: Postgres + pgvector for hybrid search over persona and global knowledge.

2. UX Entry Points
------------------
- `/` (`src/app/page.tsx`): Idea Stress Test UI. Collects idea/goal/focus, runs `/api/stress-test`, then allows refinement via `/api/idea-refinement`.
- `/copywriter` (`src/app/copywriter/page.tsx`): Copywriter UI. Select persona + platform/format, generate copy via `/api/copywriter`.

3. Data + AI Flow
-----------------
1) **Persona metadata** lives in `data/personas/<id>/persona.json` and optional `persona_strategic_depth.md`.
2) **Persona knowledge** in `data/personas/<id>/knowledge/*` and **global knowledge** in `data/global-knowledge/*` are ingested into Postgres via `npm run embed`.
3) **RAG**: `src/lib/rag.ts` performs hybrid search (FTS + vector) and feeds context into `src/lib/personaProvider.ts`.
4) **Stress Test** (`/api/stress-test`):
   - Validates the request, loads persona context, applies challenge‑level rules, and requests a JSON‑shaped critique from OpenAI.
   - Persists usage logs to Postgres (best‑effort).
5) **Idea Refinement** (`/api/idea-refinement`):
   - Asks missing‑info questions (if needed) then rewrites the pitch with structured changes.
6) **Copywriter** (`/api/copywriter`):
   - Loads platform + format rules from `data/copywriter/**` and applies persona context to produce copy variants.
7) **Legacy Scorecard** (`/api/scorecard`):
   - Computes an efficiency score + narrative. UI component `src/components/IntakeForm.tsx` exists but is not wired to `/`.

4. Key Modules
--------------
- `src/app/page.tsx`: Stress test UI, submission + refinement flow.
- `src/app/copywriter/page.tsx`: Copywriter UI.
- `src/lib/personaProvider.ts`: loads persona files and merges RAG context.
- `src/lib/rag.ts`: hybrid search (keyword + vector) with pgvector.
- `src/lib/aiNarrative.ts`: deterministic + LLM narrative helpers for scorecard/insights.

5. Configuration & Environment
------------------------------
Required environment variables (set in `.env.local` for local dev):
- `OPENAI_API_KEY` — required for all AI calls.
- `POSTGRES_URL_LOCAL` — required for local Postgres (RAG + logs).
- `POSTGRES_URL` — required for Vercel/production.
- `OPENAI_MODEL` — optional override for chat models.

Note: `src/lib/clients.ts` validates DB + OpenAI env on module load. Without DB env vars, API routes that import persona/RAG helpers will fail.

6. Local Development
--------------------
1. Install deps: `npm install`.
2. Copy `.env.example` → `.env.local` and set keys.
3. Start DB: `docker-compose up -d`.
4. Run schema: `npm run db:setup`.
5. Ingest data: `npm run embed`.
6. Run dev server: `npm run dev`.

7. Extending the System
-----------------------
- **Add a persona**: create `data/personas/<id>/persona.json` with fields used by `personaProvider`.
- **Add persona knowledge**: drop files into `data/personas/<id>/knowledge/`, then run `npm run embed`.
- **Add global knowledge**: drop files into `data/global-knowledge/`, then run `npm run embed`.
- **Add industries**: add JSON to `data/industries/` (used by scorecard).
- **Add challenge levels**: add JSON to `data/challengelevels/`.
- **Add copywriter platforms/formats**: add JSON under `data/copywriter/digital-platforms/`.

8. Known Limitations & Risks
----------------------------
- RAG requires Postgres to be available; missing DB env vars will break routes that import the RAG stack.
- AI output quality depends on prompt design and available persona knowledge.
- Some legacy endpoints (scorecard/persona Q&A) are still present but not wired to the main UI.

9. Reference Commands
---------------------
- `npm run dev` — local development server
- `npm run build && npm start` — production build/start
- `npm run lint` — ESLint across repo
- `npm run db:setup` — create schema/indexes
- `npm run embed` — ingest data into Postgres

10. Idea Stress Testing Tool
----------------------------
- **Challenge Levels**: Level 1 = `supportive`, Level 2 = `validation`, Level 3 = `critical`. These files live in `data/challengelevels/` and are loaded by `src/lib/challengeLevels.ts`.
- **API**: `/api/stress-test` accepts `{ personaType, challengeLevelId, idea, goal, evaluationFocus }` and returns a structured critique plus confidence.

